<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>캐릭터 챗봇</title>
    <link rel="stylesheet" href="/static/character_chat.css">
</head>

<body>

    <div class="chat-container">
        <div class="chat-header">
            <img src="/static/profiles/{{ character_name }}.png" alt="{{ character_name }}" class="profile-pic">
            <h2>{{ character_name }}와의 대화</h2>
        </div>

        <div id="chat-box" class="chat-box">
            <!-- 대화 내용이 여기에 추가됨 -->
        </div>

        <div class="chat-input">
            <input type="text" id="user-input" placeholder="메시지를 입력하세요...">
            <button id="send-btn">전송</button>
        </div>
    </div>

    <script>
        const characterName = "{{ character_name }}";

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        function addMessage(role, text) {
            const chatBox = document.getElementById('chat-box');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + role;
            messageDiv.innerText = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            addMessage('user', text); // 사용자가 입력한 메시지 추가
            input.value = '';

            try {
                const response = await fetch('/chat/character/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        character: characterName,
                        question: text,
                        retrieved_conversations: []  // (추후 검색 기록 붙일 수 있음)
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    addMessage('bot', data.response); // 챗봇 답변 추가
                } else {
                    addMessage('bot', '⚠️ 다시 시도해 주세요.');
                }
            } catch (error) {
                console.error(error);
                addMessage('bot', '⚠️ 서버에 연결할 수 없습니다.');
            }
        }
    </script>

</body>

</html>